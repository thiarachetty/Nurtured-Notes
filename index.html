<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Nurtured Notes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>Nurtured Notes</h1>
      <div id="weather-widget" class="widget"></div>
    </header>
    <main>
      <section class="calendar-section widget">
        <div class="calendar-header" id="calendar-header">
          <span id="calendar-title"></span>
          <button id="calendar-expand-btn" aria-label="Expand Calendar">📅</button>
        </div>
        <div id="calendar" class="calendar"></div>
        <div id="calendar-modal" class="modal">
          <div class="modal-content">
            <span class="close" id="calendar-close-btn">&times;</span>
            <h2>Add Important Date</h2>
            <form id="calendar-form">
              <label for="event-date">Date:</label>
              <input type="date" id="event-date" required>
              <label for="event-note">Note:</label>
              <textarea id="event-note" rows="3" required></textarea>
              <button type="submit">Add Date</button>
            </form>
            <div id="important-dates"></div>
          </div>
        </div>
      </section>
      <section class="todo-section widget">
        <h2>To-Do List</h2>
        <form id="todo-form">
          <input type="text" id="todo-input" placeholder="Add a task..." maxlength="50" required>
          <button type="submit">+</button>
        </form>
        <ul id="todo-list"></ul>
        <div class="progress-bar-container">
          <div id="progress-bar"></div>
        </div>
      </section>
      <section class="mood-section widget">
        <h2>How are you feeling?</h2>
        <div id="mood-buttons">
          <button data-mood="happy" class="mood-btn">😊</button>
          <button data-mood="calm" class="mood-btn">🌿</button>
          <button data-mood="sad" class="mood-btn">😔</button>
          <button data-mood="stressed" class="mood-btn">😣</button>
          <button data-mood="motivated" class="mood-btn">💪</button>
        </div>
        <div id="mood-tip"></div>
      </section>
    </main>
  </div>
  <script>
    // --- Weather Widget ---
    function fetchWeather() {
      const apiKey = 'demo'; // Replace with your API key for production use
      const weatherEl = document.getElementById('weather-widget');
      weatherEl.innerHTML = 'Loading weather...';

      // Use a free weather API for demo purposes (metaweather is deprecated, use open-meteo instead)
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          try {
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
            const data = await res.json();
            const w = data.current_weather;
            weatherEl.innerHTML = `
              <span>🌤️ ${w.temperature}°C ${w.weathercode === 0 ? "Clear" : ""}</span>
            `;
          } catch {
            weatherEl.innerHTML = "Weather unavailable";
          }
        }, () => {
          weatherEl.innerHTML = "Allow location for weather";
        });
      } else {
        weatherEl.innerHTML = "Weather unavailable";
      }
    }
    fetchWeather();

    // --- Calendar Widget ---
    const calendar = document.getElementById('calendar');
    const calendarTitle = document.getElementById('calendar-title');
    const calendarExpandBtn = document.getElementById('calendar-expand-btn');
    const calendarModal = document.getElementById('calendar-modal');
    const calendarCloseBtn = document.getElementById('calendar-close-btn');
    const calendarForm = document.getElementById('calendar-form');
    const eventDate = document.getElementById('event-date');
    const eventNote = document.getElementById('event-note');
    const importantDatesEl = document.getElementById('important-dates');

    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let importantDates = JSON.parse(localStorage.getItem('plannerImportantDates') || '{}');

    function renderCalendar(month, year) {
      calendar.innerHTML = '';
      const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      calendarTitle.textContent = `${monthNames[month]} ${year}`;
      let firstDay = new Date(year, month).getDay();
      let daysInMonth = new Date(year, month+1, 0).getDate();
      let table = document.createElement('table');
      let thead = document.createElement('thead');
      let headerRow = document.createElement('tr');
      ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(day=>{
        let th = document.createElement('th');
        th.textContent = day;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);
      let date = 1;
      for(let i=0; i<6; i++) {
        let row = document.createElement('tr');
        for(let j=0; j<7; j++) {
          let cell = document.createElement('td');
          if(i===0 && j<firstDay) {
            cell.textContent = '';
          } else if(date > daysInMonth) {
            cell.textContent = '';
          } else {
            cell.textContent = date;
            let key = `${year}-${String(month+1).padStart(2,'0')}-${String(date).padStart(2,'0')}`;
            if (importantDates[key]) {
              cell.classList.add('important');
              cell.title = importantDates[key];
            }
            if (date === new Date().getDate() && month===new Date().getMonth() && year===new Date().getFullYear()) {
              cell.classList.add('today');
            }
            date++;
          }
          row.appendChild(cell);
        }
        table.appendChild(row);
      }
      calendar.appendChild(table);
    }
    function updateImportantDatesList() {
      importantDatesEl.innerHTML = '<h3>Important Dates</h3>';
      const items = Object.entries(importantDates).sort();
      if (items.length === 0) {
        importantDatesEl.innerHTML += "<p>No important dates yet.</p>";
        return;
      }
      items.forEach(([date, note]) => {
        const div = document.createElement('div');
        div.className = 'important-date-item';
        div.innerHTML = `<strong>${date}</strong>: ${note} <button data-date="${date}" class="delete-date">x</button>`;
        importantDatesEl.appendChild(div);
      });
      document.querySelectorAll('.delete-date').forEach(btn => {
        btn.onclick = function() {
          delete importantDates[this.dataset.date];
          localStorage.setItem('plannerImportantDates', JSON.stringify(importantDates));
          renderCalendar(currentMonth, currentYear);
          updateImportantDatesList();
        }
      });
    }
    renderCalendar(currentMonth, currentYear);

    calendarExpandBtn.onclick = () => {
      calendarModal.style.display = 'block';
      eventDate.value = '';
      eventNote.value = '';
      updateImportantDatesList();
    }
    calendarCloseBtn.onclick = () => {
      calendarModal.style.display = 'none';
    }
    window.onclick = function(e) {
      if (e.target === calendarModal) calendarModal.style.display = "none";
    }
    calendarForm.onsubmit = function(e) {
      e.preventDefault();
      const key = eventDate.value;
      const note = eventNote.value;
      if (key && note) {
        importantDates[key] = note;
        localStorage.setItem('plannerImportantDates', JSON.stringify(importantDates));
        renderCalendar(currentMonth, currentYear);
        updateImportantDatesList();
        eventDate.value = '';
        eventNote.value = '';
      }
    }

    // --- To-Do List with Progress Bar ---
    const todoForm = document.getElementById('todo-form');
    const todoInput = document.getElementById('todo-input');
    const todoList = document.getElementById('todo-list');
    const progressBar = document.getElementById('progress-bar');
    let todos = JSON.parse(localStorage.getItem('plannerTodos') || '[]');
    function renderTodos() {
      todoList.innerHTML = '';
      todos.forEach((todo, i) => {
        let li = document.createElement('li');
        li.className = todo.done ? 'done' : '';
        li.innerHTML = `
          <input type="checkbox" ${todo.done ? "checked" : ""} data-idx="${i}">
          <span>${todo.text}</span>
          <button data-idx="${i}" class="delete-todo">x</button>
        `;
        todoList.appendChild(li);
      });
      updateProgressBar();
      document.querySelectorAll('.delete-todo').forEach(btn => {
        btn.onclick = function() {
          todos.splice(this.dataset.idx,1);
          localStorage.setItem('plannerTodos', JSON.stringify(todos));
          renderTodos();
        }
      });
      document.querySelectorAll('input[type=checkbox]').forEach(box => {
        box.onchange = function() {
          todos[this.dataset.idx].done = this.checked;
          localStorage.setItem('plannerTodos', JSON.stringify(todos));
          renderTodos();
        }
      });
    }
    function updateProgressBar() {
      if (todos.length === 0) {
        progressBar.style.width = "0%";
        progressBar.textContent = "";
        return;
      }
      const done = todos.filter(t=>t.done).length;
      const percent = Math.round((done/todos.length)*100);
      progressBar.style.width = percent + '%';
      progressBar.textContent = percent + '%';
    }
    todoForm.onsubmit = function(e) {
      e.preventDefault();
      if (todoInput.value.trim() !== "") {
        todos.push({text: todoInput.value, done:false});
        localStorage.setItem('plannerTodos', JSON.stringify(todos));
        todoInput.value = '';
        renderTodos();
      }
    }
    renderTodos();

    // --- Mood Tracker ---
    const moodButtons = document.querySelectorAll('.mood-btn');
    const moodTip = document.getElementById('mood-tip');
    const moodTips = {
      happy: "Keep sharing your joy with others and savor the little moments!",
      calm: "Let your calm energy inspire your day. Maybe enjoy a cup of herbal tea.",
      sad: "It's okay to feel sad. Try a walk in nature or write down your feelings.",
      stressed: "Take a deep breath. A few minutes of mindful breathing can help.",
      motivated: "Channel your motivation into something creative or helpful today!"
    };
    moodButtons.forEach(btn => {
      btn.onclick = function() {
        const mood = this.dataset.mood;
        moodTip.textContent = moodTips[mood] || "Wishing you a lovely day!";
        localStorage.setItem('plannerMood', mood);
      };
    });
    // Restore last mood
    const lastMood = localStorage.getItem('plannerMood');
    if (lastMood && moodTips[lastMood]) {
      moodTip.textContent = moodTips[lastMood];
    }
  </script>
</body>
</html>